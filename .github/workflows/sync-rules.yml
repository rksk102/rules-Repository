name: "1. Daily Sync and Sanitize Rules"

on:
  workflow_dispatch:
  schedule:
    - cron: "0 21 * * *"  # åŒ—äº¬æ—¶é—´ 05:00

permissions:
  contents: write
  actions: write

concurrency:
  group: sync-rules
  cancel-in-progress: true

jobs:
  sync-job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Make scripts executable
        run: |
          chmod +x scripts/sync.sh
          if [ -f "scripts/lib/processor.py" ]; then
            chmod +x scripts/lib/processor.py
          fi

      # æ ¸å¿ƒæ­¥éª¤ï¼šè¿è¡ŒåŒæ­¥è„šæœ¬ï¼Œå¹¶ä½¿ç”¨ tee è®°å½•æ—¥å¿—ä»¥ä¾¿åç»­åˆ†æ
      - name: Run Sync Script with Logging
        id: run_sync
        shell: bash
        env:
          STRICT: "false"
          TERM: xterm-color # ä¿ç•™é¢œè‰²è¾“å‡º
        run: |
          echo "::group::ğŸ“œ Real-time Execution Logs (Click to expand)"
          
          # åˆ›å»ºæ—¥å¿—æ–‡ä»¶
          touch sync_execution.log
          
          # ä½¿ç”¨ pipefail ç¡®ä¿ç®¡é“ä¸­ä»»ä½•é”™è¯¯éƒ½èƒ½è¢«æ•è·
          set -o pipefail
          
          # è¿è¡Œè„šæœ¬ï¼ŒåŒæ—¶è¾“å‡ºåˆ°å±å¹•å’Œæ–‡ä»¶
          # 2>&1 ç¡®ä¿é”™è¯¯è¾“å‡ºä¹Ÿè¢«æ•æ‰
          ./scripts/sync.sh 2>&1 | tee sync_execution.log
          EXIT_CODE=$?
          
          echo "::endgroup::"
          
          # ä¿å­˜çŠ¶æ€ä¾›åç»­æ­¥éª¤åˆ¤æ–­
          echo "exit_code=$EXIT_CODE" >> "$GITHUB_OUTPUT"
          if [ $EXIT_CODE -ne 0 ]; then
            echo "status=failure" >> "$GITHUB_OUTPUT"
          else
            echo "status=success" >> "$GITHUB_OUTPUT"
          fi

      # ç¾åŒ–æ­¥éª¤ï¼šç”Ÿæˆå¯è§†åŒ–çš„ä½œä¸šæ‘˜è¦æŠ¥å‘Š (ä¿®å¤ï¼šç²¾å‡†æå–ä¸‹è½½å¤±è´¥ä¸è§£æå¤±è´¥çš„URL)
      - name: Generate Execution Report
        if: always() # æ— è®ºæˆåŠŸå¤±è´¥éƒ½è¿è¡Œ
        shell: bash
        run: |
          LOG_FILE="sync_execution.log"
          
          # é˜²æ­¢æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨å¯¼è‡´è„šæœ¬å´©æºƒ
          if [ ! -f "$LOG_FILE" ]; then
            echo "Log file not found. Skipping report."
            exit 0
          fi
          
          # --- ç»Ÿè®¡æ•°æ®æå– ---
          
          # ç»Ÿè®¡ "Saved:" å‡ºç°æ¬¡æ•° (|| echo 0 é˜²æ­¢ grep æ‰¾ä¸åˆ°è¿”å›é”™è¯¯ç )
          SUCCESS_COUNT=$(grep -c "Saved:" "$LOG_FILE" || echo 0)
          
          # ç»Ÿè®¡æ€»è¡Œæ•°ï¼šæå– 'Saved: ... 1234 lines' ä¸­çš„æ•°å­—
          # ä½¿ç”¨ awk ä»å€’æ•°ç¬¬äºŒåˆ—æå–æ•°å­—ï¼Œé˜²æ­¢è·¯å¾„ä¸­æœ‰æ•°å­—å¹²æ‰°
          TOTAL_LINES=$(grep "Saved:" "$LOG_FILE" | awk '{print $(NF-1)}' | awk '{s+=$1} END {print s+0}' || echo 0)
          
          # 1. æå–ä¸‹è½½å¤±è´¥çš„ URL (grep åŒ¹é… http)
          # å¯¹åº” sync.sh è¾“å‡º: "::warning::Download failed: https://..."
          DOWNLOAD_FAILS=$(grep "::warning::Download failed" "$LOG_FILE" | grep -oE 'https?://[^ ]+' | sort | uniq || true)
          
          # 2. æå–è§£æ/Pythonå¤±è´¥çš„ URL
          # å¯¹åº” sync.sh è¾“å‡º: "::error::Processing failed for https://..."
          PARSE_FAILS=$(grep "::error::Processing failed" "$LOG_FILE" | grep -oE 'https?://[^ ]+' | sort | uniq || true)
          
          # è®¡ç®—å„ç±»å¤±è´¥æ•°
          COUNT_DL=$(echo "$DOWNLOAD_FAILS" | grep -c "http" || echo 0)
          COUNT_PS=$(echo "$PARSE_FAILS" | grep -c "http" || echo 0)
          FAIL_COUNT=$((COUNT_DL + COUNT_PS))
          
          # --- ç”Ÿæˆ Markdown æ‘˜è¦åˆ° GITHUB_STEP_SUMMARY ---
          {
            echo "## ğŸ”„ Daily Sync Report"
            echo ""
            echo "| Metric | Count |"
            echo "| :--- | :--- |"
            echo "| âœ… **Success** | **$SUCCESS_COUNT** |"
            echo "| âŒ **Failures** | **$FAIL_COUNT** |"
            echo "| ğŸ“Š **Total Lines** | \`$TOTAL_LINES\` |"
            echo ""
            
            if [ "$FAIL_COUNT" -gt 0 ]; then
              echo "### âš ï¸ Failure Details"
              echo "| Type | Failed Source URL |"
              echo "| :--- | :--- |"
              
              # è¾“å‡ºä¸‹è½½å¤±è´¥åˆ—è¡¨
              if [ "$COUNT_DL" -gt 0 ]; then
                while IFS= read -r url; do
                  [ -z "$url" ] && continue
                  echo "| ğŸ“¥ **Download** | \`$url\` |"
                done <<< "$DOWNLOAD_FAILS"
              fi
              
              # è¾“å‡ºè§£æå¤±è´¥åˆ—è¡¨
              if [ "$COUNT_PS" -gt 0 ]; then
                while IFS= read -r url; do
                   [ -z "$url" ] && continue
                   echo "| âš™ï¸ **Parse** | \`$url\` |"
                done <<< "$PARSE_FAILS"
              fi
              
              echo ""
              echo "> ğŸ’¡ _Check the **Run Sync Script** logs above for Python tracebacks or HTTP errors._"
            else
              echo "### ğŸ‰ All Systems Operational"
              echo "No errors detected."
            fi
            
            echo ""
            echo "---"
            echo "Build Time: $(date +'%Y-%m-%d %H:%M:%S UTC')"
            
          } >> "$GITHUB_STEP_SUMMARY"

      # æ£€æŸ¥ä¹‹å‰çš„åŒæ­¥è„šæœ¬æ˜¯å¦å¤±è´¥ï¼Œå¦‚æœå¤±è´¥åˆ™åœ¨æ­¤å¤„ç»ˆæ­¢ Workflow
      - name: Check Final Status
        if: steps.run_sync.outputs.status == 'failure'
        run: |
          echo "::error::Sync script failed with exit code ${{ steps.run_sync.outputs.exit_code }}"
          exit 1
