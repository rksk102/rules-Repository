name: "1. Daily Sync and Sanitize Rules"

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    name: "ğŸ“¥ Sync & Process"
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ Setup Python 3
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # æ­¥éª¤ 1ï¼šä¸‹è½½ (è°ƒç”¨ sync.sh)
      - name: ğŸ“¡ Download Rules
        id: download
        env:
          TERM: xterm-color
        run: |
          # ç¡®ä¿è„šæœ¬æœ‰æ‰§è¡Œæƒé™
          chmod +x scripts/sync.sh
          # æ‰§è¡Œè„šæœ¬
          ./scripts/sync.sh

      # æ­¥éª¤ 2ï¼šæ¸…æ´—ä¸ä¼˜åŒ– (è°ƒç”¨ processor.py)
      - name: ğŸ§  Sanitize & Optimize
        id: sanitize
        env:
          TERM: xterm-color
        run: |
          python3 scripts/lib/processor.py

      - name: ğŸ’¾ Commit Changes
        id: commit
        run: |
          git config user.name 'GitHub Actions Bot'
          git config user.email 'actions@github.com'
          
          # æ·»åŠ  rulesets ç›®å½•å˜åŠ¨
          git add rulesets/
          
          if git diff-index --quiet HEAD; then
             echo "::notice::No updates found."
          else
             CHANGE_COUNT=$(git diff --name-only --cached | wc -l)
             echo "::notice::$CHANGE_COUNT files updated."
             
             git commit -m "chore: ğŸ“¥ Sync & Sanitize $CHANGE_COUNT rule files [$(date +'%Y-%m-%d')]"
             git push
          fi

      - name: âœ¨ Final Status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "Sync workflow finished successfully."
          else
            echo "::error::Workflow failed. Check logs."
          fi
