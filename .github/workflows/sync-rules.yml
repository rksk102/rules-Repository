name: "1. Daily Sync and Sanitize Rules"

on:
  workflow_dispatch:
  schedule:
    - cron: "0 21 * * *"  # Âåó‰∫¨Êó∂Èó¥ 05:00

permissions:
  contents: write
  actions: write

concurrency:
  group: sync-rules
  cancel-in-progress: true

jobs:
  sync-job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Make scripts executable
        run: |
          chmod +x scripts/sync.sh
          if [ -f "scripts/lib/processor.py" ]; then
            chmod +x scripts/lib/processor.py
          fi

      # Ê†∏ÂøÉÊ≠•È™§ÔºöËøêË°åÂêåÊ≠•ËÑöÊú¨ÔºåÂπ∂‰ΩøÁî® tee ËÆ∞ÂΩïÊó•Âøó‰ª•‰æøÂêéÁª≠ÂàÜÊûê
      - name: Run Sync Script with Logging
        id: run_sync
        shell: bash
        env:
          STRICT: "false"
          TERM: xterm-color #‰ª•Ê≠§‰øùÁïôÈ¢úËâ≤ËæìÂá∫
        run: |
          echo "::group::üìú Real-time Execution Logs (Click to expand)"
          
          # ÂàõÂª∫‰∏¥Êó∂Êó•ÂøóÊñá‰ª∂
          touch sync_execution.log
          
          # ËøêË°åËÑöÊú¨ | tee ÂêåÊó∂ËæìÂá∫Âà∞Â±èÂπïÂíåÊñá‰ª∂
          # ‰ΩøÁî® pipefail Á°Æ‰øùËÑöÊú¨Âá∫ÈîôËÉΩË¢´ÊçïËé∑
          set -o pipefail
          ./scripts/sync.sh 2>&1 | tee sync_execution.log
          
          EXIT_CODE=$?
          
          echo "::endgroup::"
          
          # Â∞ÜÈÄÄÂá∫‰ª£Á†Å‰º†ÈÄíÁªô‰∏ã‰∏ÄÊ≠•ÔºàÂç≥‰ΩøÂ§±Ë¥•‰πüÂÖàÁªßÁª≠Ôºå‰ª•‰æøÁîüÊàêÊä•ÂëäÔºâ
          echo "exit_code=$EXIT_CODE" >> "$GITHUB_OUTPUT"
          if [ $EXIT_CODE -ne 0 ]; then
            echo "status=failure" >> "$GITHUB_OUTPUT"
          else
            echo "status=success" >> "$GITHUB_OUTPUT"
          fi

      # ÁæéÂåñÊ≠•È™§ÔºöÁîüÊàêÂèØËßÜÂåñÁöÑ‰Ωú‰∏öÊëòË¶ÅÊä•Âëä
      - name: Generate Execution Report
        if: always() # Êó†ËÆ∫ÊàêÂäüÂ§±Ë¥•ÈÉΩËøêË°å
        shell: bash
        run: |
          LOG_FILE="sync_execution.log"
          
          # --- ÁªüËÆ°Êï∞ÊçÆÊèêÂèñ ---
          # ÁªüËÆ° "Saved:" Âá∫Áé∞ÁöÑÊ¨°Êï∞‰Ωú‰∏∫ÊàêÂäüÊï∞
          SUCCESS_COUNT=$(grep -c "Saved:" "$LOG_FILE" || echo 0)
          # ÁªüËÆ° "::warning::Download failed" Êàñ "::error::" Âá∫Áé∞ÁöÑÊ¨°Êï∞
          FAIL_COUNT=$(grep -E -c "(::warning::Download failed|::error::)" "$LOG_FILE" || echo 0)
          # ÁªüËÆ°ÊÄªÂÖ±‰∏ãËΩΩÁöÑËßÑÂàôË°åÊï∞ (‰ªé Saved: ... (\d+) lines ÊèêÂèñ)
          TOTAL_LINES=$(grep "Saved:" "$LOG_FILE" | awk -F'\\(' '{print $2}' | awk '{print $1}' | awk '{s+=$1} END {print s}' || echo 0)
          
          # ÊèêÂèñÊâÄÊúâÁöÑÂ§±Ë¥• URL
          FAILED_URLS=$(grep -E "Source: https?://" "$LOG_FILE" -A 2 | grep -B 2 "::warning" | grep "Source:" | awk '{print $2}' | sort | uniq)
          
          # --- ÁîüÊàê Markdown ÊëòË¶Å ---
          {
            echo "## üîÑ Daily Sync Report"
            echo ""
            echo "| Metric | Count |"
            echo "| :--- | :--- |"
            echo "| ‚úÖ **Success Sources** | **$SUCCESS_COUNT** |"
            echo "| ‚ùå **Failed Sources** | **$FAIL_COUNT** |"
            echo "| üìä **Total Rules Parsed** | $TOTAL_LINES lines |"
            echo ""
            
            if [ "$FAIL_COUNT" -gt 0 ]; then
              echo "### ‚ö†Ô∏è Failed Sources List"
              echo "> The following URLs failed to download or parse:"
              echo ""
              echo "| Failed URL |"
              echo "| :--- |"
              while IFS= read -r url; do
                [ -z "$url" ] && continue
                echo "| \`$url\` |"
              done <<< "$FAILED_URLS"
              echo ""
              echo "üí° _Check the logs above for specific HTTP errors._"
            else
              echo "### üéâ All Systems Operational"
              echo "No download errors detected."
            fi
            
            echo ""
            echo "---"
            echo "Build Time: $(date +'%Y-%m-%d %H:%M:%S UTC')"
            
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Check Final Status
        if: steps.run_sync.outputs.status == 'failure'
        run: |
          echo "::error::Sync script failed with exit code ${{ steps.run_sync.outputs.exit_code }}"
          exit 1

      # Ëß¶Âèë‰∏ã‰∏Ä‰∏™Â∑•‰ΩúÊµÅ
      - name: Trigger merge-rules workflow
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          echo "Triggering merge-rules workflow..."
          gh workflow run "merge-rules.yml" --ref main
