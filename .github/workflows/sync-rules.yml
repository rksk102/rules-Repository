name: "1. Manage Rules: Sync & Sanitize"

# è§¦å‘æ¨¡å¼ï¼šä»…æ‰‹åŠ¨æˆ–APIè§¦å‘ (OpenRouter Mode)
on:
  workflow_dispatch:
    inputs:
      strict_mode:
        description: 'Strict Mode (Stop immediately on error)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  actions: write

concurrency:
  group: sync-rules
  cancel-in-progress: true

jobs:
  sync-manager:
    name: "ðŸ›¡ï¸ Sync & Sanitize Rules"
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ—ï¸ Initialize Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ Setup Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: ðŸ”§ Prepare Scripts
        run: |
          chmod +x scripts/sync.sh
          chmod +x scripts/lib/processor.py

      # æ ¸å¿ƒè¿è¡Œæ­¥éª¤ï¼šåŒ…å«æ—¥å¿—åˆ†ç»„å’Œå®žæ—¶è¾“å‡º
      - name: ðŸš€ Execute Sync & Clean
        id: run_sync
        shell: bash
        env:
          STRICT_MODE: ${{ inputs.strict_mode }}
          TERM: xterm-color
        run: |
          # åˆ›å»ºä¸´æ—¶æ—¥å¿—æ–‡ä»¶
          LOG_FILE="sync_execution.log"
          touch "$LOG_FILE"
          
          echo "::notice::Starting Sync Process... (Strict Mode: $STRICT_MODE)"
          
          # ä½¿ç”¨ pipefail æ•èŽ·ç®¡é“é”™è¯¯
          set -o pipefail
          
          # è¿è¡Œè„šæœ¬ | åŒè·¯è¾“å‡º(å±å¹•+æ–‡ä»¶)
          ./scripts/sync.sh 2>&1 | tee "$LOG_FILE"
          EXIT_CODE=$?
          
          echo "exit_code=$EXIT_CODE" >> "$GITHUB_OUTPUT"
          
          # å¦‚æžœè„šæœ¬ä»¥éž0é€€å‡ºï¼Œåœ¨æ­¤æ­¥éª¤ä¸ä»…è®°å½•ï¼Œè¿˜ä¼šæ ‡è®°æ­¥éª¤æœ¬èº«å¤±è´¥
          if [ $EXIT_CODE -ne 0 ]; then
            echo "status=failure" >> "$GITHUB_OUTPUT"
            exit 1
          else
            echo "status=success" >> "$GITHUB_OUTPUT"
          fi

      # çŽ°ä»£åŒ–å¯è§†åŒ–æŠ¥å‘Šç”Ÿæˆ (æ— è®ºæˆåŠŸå¤±è´¥éƒ½ä¼šè¿è¡Œï¼Œæ–¹ä¾¿æŸ¥çœ‹é”™è¯¯æº)
      - name: ðŸ“Š Generate Dashboard Report
        if: always()
        shell: bash
        run: |
          LOG="sync_execution.log"
          [ ! -f "$LOG" ] && exit 0
          
          # --- æ•°æ®æå–åŒº ---
          SUCCESS_COUNT=$(grep -c "SUCCESS:" "$LOG" || echo 0)
          # æå– Saved åŽé¢çš„æ•°å­—
          TOTAL_LINES=$(grep "SUCCESS:" "$LOG" | awk -F'Saved ' '{print $2}' | awk '{s+=$1} END {print s+0}' || echo 0)
          
          # æå–è¯¦ç»†é”™è¯¯åˆ—è¡¨
          DL_ERRORS=$(grep "ERROR_DL:" "$LOG" | awk '{print $2}' | sort -u || true)
          PS_ERRORS=$(grep "ERROR_PARSE:" "$LOG" | awk '{print $2}' | sort -u || true)
          
          COUNT_DL=$(echo "$DL_ERRORS" | grep -c "http" || echo 0)
          COUNT_PS=$(echo "$PS_ERRORS" | grep -c "http" || echo 0)
          TOTAL_FAIL=$((COUNT_DL + COUNT_PS))
          
          # --- æ¸²æŸ“ Markdown ---
          {
            echo "# ðŸ›¡ï¸ Rules Sync Dashboard"
            echo ""
            echo "| ðŸŸ¢ Success | ðŸ”´ Failures | ðŸ“‰ Total Rules |"
            echo "| :---: | :---: | :---: |"
            echo "| **$SUCCESS_COUNT** | **$TOTAL_FAIL** | **$TOTAL_LINES** |"
            echo ""
            
            if [ "$TOTAL_FAIL" -gt 0 ]; then
              echo "## ðŸš¨ Error Diagnostics"
              echo "> The workflow encountered errors. Please review the sources below."
              echo ""
              echo "| Type | Failed Source URL |"
              echo "| :--- | :--- |"
              
              if [ "$COUNT_DL" -gt 0 ]; then
                 while IFS= read -r url; do [ -z "$url" ] && continue; echo "| ðŸ“¡ **Download** | \`$url\` |"; done <<< "$DL_ERRORS"
              fi
              if [ "$COUNT_PS" -gt 0 ]; then
                 while IFS= read -r url; do [ -z "$url" ] && continue; echo "| ðŸ§  **Parse/Clean** | \`$url\` |"; done <<< "$PS_ERRORS"
              fi
            else
              echo "## âœ… All Systems Operational"
              echo "All rule sources were downloaded, sanitized, and converted to TXT successfully."
            fi
            
            echo ""
            echo "---"
            echo "_Report generated at $(date +'%Y-%m-%d %H:%M:%S UTC')_"
          } >> "$GITHUB_STEP_SUMMARY"
