name: "1. Daily Sync and Sanitize Rules"

on:
  workflow_dispatch:
  schedule:
    - cron: "0 21 * * *"  # åŒ—äº¬æ—¶é—´ 05:00

permissions:
  contents: write
  actions: write

concurrency:
  group: sync-rules
  cancel-in-progress: true

jobs:
  sync-job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Make scripts executable
        run: |
          chmod +x scripts/sync.sh
          if [ -f "scripts/lib/processor.py" ]; then
            chmod +x scripts/lib/processor.py
          fi

      # æ ¸å¿ƒæ­¥éª¤ï¼šè¿è¡ŒåŒæ­¥è„šæœ¬ï¼Œå¹¶ä½¿ç”¨ tee è®°å½•æ—¥å¿—ä»¥ä¾¿åç»­åˆ†æ
      - name: Run Sync Script with Logging
        id: run_sync
        shell: bash
        env:
          STRICT: "false"
          TERM: xterm-color # ä¿ç•™é¢œè‰²è¾“å‡º
        run: |
          echo "::group::ğŸ“œ Real-time Execution Logs (Click to expand)"
          
          # åˆ›å»ºæ—¥å¿—æ–‡ä»¶
          touch sync_execution.log
          
          # ä½¿ç”¨ pipefail ç¡®ä¿ç®¡é“ä¸­ä»»ä½•é”™è¯¯éƒ½èƒ½è¢«æ•è·
          set -o pipefail
          
          # è¿è¡Œè„šæœ¬ï¼ŒåŒæ—¶è¾“å‡ºåˆ°å±å¹•å’Œæ–‡ä»¶
          # 2>&1 ç¡®ä¿é”™è¯¯è¾“å‡ºä¹Ÿè¢«æ•æ‰
          ./scripts/sync.sh 2>&1 | tee sync_execution.log
          EXIT_CODE=$?
          
          echo "::endgroup::"
          
          # ä¿å­˜çŠ¶æ€ä¾›åç»­æ­¥éª¤åˆ¤æ–­
          echo "exit_code=$EXIT_CODE" >> "$GITHUB_OUTPUT"
          if [ $EXIT_CODE -ne 0 ]; then
            echo "status=failure" >> "$GITHUB_OUTPUT"
          else
            echo "status=success" >> "$GITHUB_OUTPUT"
          fi

      # ç¾åŒ–æ­¥éª¤ï¼šç”Ÿæˆå¯è§†åŒ–çš„ä½œä¸šæ‘˜è¦æŠ¥å‘Š (å·²ä¿®å¤ grep é€€å‡ºç é—®é¢˜)
      - name: Generate Execution Report
        if: always() # æ— è®ºæˆåŠŸå¤±è´¥éƒ½è¿è¡Œ
        shell: bash
        run: |
          LOG_FILE="sync_execution.log"
          
          # é˜²æ­¢æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨å¯¼è‡´è„šæœ¬å´©æºƒ
          if [ ! -f "$LOG_FILE" ]; then
            echo "Log file not found. Skipping report."
            exit 0
          fi
          
          # --- ç»Ÿè®¡æ•°æ®æå– ---
          
          # ç»Ÿè®¡ "Saved:" å‡ºç°æ¬¡æ•° (|| echo 0 é˜²æ­¢ grep æ‰¾ä¸åˆ°è¿”å›é”™è¯¯ç )
          SUCCESS_COUNT=$(grep -c "Saved:" "$LOG_FILE" || echo 0)
          
          # ç»Ÿè®¡å¤±è´¥æ¬¡æ•°
          FAIL_COUNT=$(grep -E -c "(::warning::Download failed|::error::)" "$LOG_FILE" || echo 0)
          
          # ç»Ÿè®¡æ€»è¡Œæ•°ï¼šæå– 'Saved: ... 1234 lines' ä¸­çš„æ•°å­—
          # ä½¿ç”¨ awk ä»å€’æ•°ç¬¬äºŒåˆ—æå–æ•°å­—ï¼Œé˜²æ­¢è·¯å¾„ä¸­æœ‰æ•°å­—å¹²æ‰°
          TOTAL_LINES=$(grep "Saved:" "$LOG_FILE" | awk '{print $(NF-1)}' | awk '{s+=$1} END {print s+0}' || echo 0)
          
          # æå–å¤±è´¥ URL (ä»…å½“æœ‰å¤±è´¥æ—¶å°è¯•æå–ï¼Œå¹¶åŠ  || true å…œåº•)
          FAILED_URLS=""
          if [ "$FAIL_COUNT" -gt 0 ]; then
             # æå–é€»è¾‘ï¼šæ‰¾åˆ° Warning è¡Œï¼Œå‘ä¸Šæ‰¾ Source è¡Œï¼Œæå– URL
             # åŠ ä¸Š || true ç¡®ä¿ grep é“¾å³ä½¿ä¸ºç©ºä¹Ÿä¸æŠ¥é”™
             FAILED_URLS=$(grep -B 5 "::warning::Download failed" "$LOG_FILE" | grep "Source:" | awk '{print $2}' | sort | uniq || true)
          fi
          
          # --- ç”Ÿæˆ Markdown æ‘˜è¦åˆ° GITHUB_STEP_SUMMARY ---
          {
            echo "## ğŸ”„ Daily Sync Report"
            echo ""
            echo "| Metric | Count |"
            echo "| :--- | :--- |"
            echo "| âœ… **Success Sources** | **$SUCCESS_COUNT** |"
            echo "| âŒ **Failed Sources** | **$FAIL_COUNT** |"
            echo "| ğŸ“Š **Total Rules Parsed** | $TOTAL_LINES lines |"
            echo ""
            
            if [ "$FAIL_COUNT" -gt 0 ]; then
              echo "### âš ï¸ Failed Sources List"
              echo "> The following URLs failed to download or parse:"
              echo ""
              echo "| Failed URL |"
              echo "| :--- |"
              # å¦‚æœ FAILED_URLS ä¸ºç©ºä½† COUNT > 0 (ä¾‹å¦‚è§£æé”™è¯¯è€Œéä¸‹è½½é”™è¯¯)ï¼Œæ˜¾ç¤ºæç¤º
              if [ -z "$FAILED_URLS" ]; then
                 echo "| _(Unknown sources, check logs)_ |"
              else
                 while IFS= read -r url; do
                   [ -z "$url" ] && continue
                   echo "| \`$url\` |"
                 done <<< "$FAILED_URLS"
              fi
              echo ""
              echo "ğŸ’¡ _Check the **Run Sync Script** logs for specific HTTP errors._"
            else
              echo "### ğŸ‰ All Systems Operational"
              echo "No download errors detected."
            fi
            
            echo ""
            echo "---"
            echo "Build Time: $(date +'%Y-%m-%d %H:%M:%S UTC')"
            
          } >> "$GITHUB_STEP_SUMMARY"

      # æ£€æŸ¥ä¹‹å‰çš„åŒæ­¥è„šæœ¬æ˜¯å¦å¤±è´¥ï¼Œå¦‚æœå¤±è´¥åˆ™åœ¨æ­¤å¤„ç»ˆæ­¢ Workflow
      - name: Check Final Status
        if: steps.run_sync.outputs.status == 'failure'
        run: |
          echo "::error::Sync script failed with exit code ${{ steps.run_sync.outputs.exit_code }}"
          exit 1

      # è§¦å‘ä¸‹ä¸€ä¸ªå·¥ä½œæµï¼šmerge-rules
      - name: Trigger merge-rules workflow
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          echo "Triggering merge-rules workflow..."
          gh workflow run "merge-rules.yml" --ref main
