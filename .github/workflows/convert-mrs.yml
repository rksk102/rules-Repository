name: "3. Convert to MRS"

on:
  workflow_dispatch:

jobs:
  convert-job:
    name: "ğŸ¦„ Convert & Compile"
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Scripts
        uses: actions/checkout@v4

      - name: ğŸ“¦ Download Source (TXT)
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: merge-rules.yml
          name: merged_rules_artifact
          path: merged-rules
          search_artifacts: true
          workflow_conclusion: success

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: â¬‡ï¸ Install Python Deps
        run: pip install requests

      - name: ğŸš€ Run Conversion Script
        env:
          # å…³é”®ï¼šä¼ é€’ Token ç»™è„šæœ¬ï¼Œç”¨äºæ— é™æµè·å– Latest Release API
          GH_TOKEN: ${{ github.token }}
        run: |
          # èµ‹äºˆè„šæœ¬æ‰§è¡Œæƒé™
          chmod +x scripts/convert_mrs.py
          # è¿è¡Œï¼Œå¹¶ç¡®ä¿æ—¥å¿—æµå®æ—¶åˆ·æ–°
          python3 -u scripts/convert_mrs.py

      - name: ğŸ“¤ Upload Result (MRS)
        uses: actions/upload-artifact@v4
        with:
          name: mrs_rules_artifact
          path: merged-rules-mrs/
          retention-days: 1

      # ğŸ”¥ 2. ã€æ–°å¢ã€‘å°†ç”Ÿæˆçš„æ–‡ä»¶å¤¹æ¨é€åˆ°ä»“åº“æ ¹ç›®å½• ğŸ”¥
      - name: ğŸ’¾ Commit & Push to Repo
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          # æäº¤ä¿¡æ¯ä¸­åŠ å…¥ [skip ci] æ˜¯ä¸ºäº†é˜²æ­¢è¿™æ¬¡æäº¤åˆè§¦å‘æ–°çš„ Actionsï¼Œé€ æˆæ— é™æ­»å¾ªç¯
          commit_message: "ğŸ¤– Auto-generated MRS rules [skip ci]"
          
          # æŒ‡å®šè¦æäº¤çš„æ–‡ä»¶å¤¹
          file_pattern: merged-rules-mrs/
          
          # ä½ çš„ä¸»åˆ†æ”¯åç§° (é€šå¸¸æ˜¯ main æˆ– master)
          branch: main
          
          # å¦‚æœæ–‡ä»¶å¤¹æ²¡æœ‰å˜åŒ–ï¼Œä¸è¿›è¡Œæäº¤
          skip_dirty_check: false
          
          # è‡ªåŠ¨åˆ›å»ºä½œè€…ä¿¡æ¯
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"
