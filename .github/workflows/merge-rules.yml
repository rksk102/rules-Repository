name: "2. Merge Rules based on Config"

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["1. Daily Sync and Sanitize Rules"]
    types:
      - completed

permissions:
  contents: write
  actions: read

jobs:
  merge-job:
    # ç¡®ä¿ä¸Šä¸€ä¸ªå·¥ä½œæµæ˜¯æˆåŠŸçš„ï¼Œæˆ–è€…æ˜¯æ‰‹åŠ¨è§¦å‘çš„
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    name: "ðŸ§© Merge & Organize Rules"
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: main  # ç¡®ä¿æ‹‰å–æœ€æ–°ä»£ç 

      - name: ðŸ Setup Python 3
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip' # å¼€å¯ç¼“å­˜ï¼ŒåŠ å¿«é€Ÿåº¦

      - name: ðŸ“¦ Install Dependencies
        run: |
          pip install --upgrade pip
          pip install PyYAML
          
      - name: ðŸ” Validate Config
        id: validate
        run: |
          if [ ! -f "merge-config.yaml" ]; then
            echo "::error::merge-config.yaml is missing!"
            exit 1
          fi
          echo "::notice::Config file found, proceeding..."

      - name: ðŸš€ Run Merge Script
        id: run_merger
        env:
          TERM: xterm-color # å¼ºåˆ¶å¼€å¯å½©è‰²è¾“å‡º
        run: |
          chmod +x scripts/merge-rules.sh
          ./scripts/merge-rules.sh

      - name: ðŸ’¾ Commit Changes
        id: commit
        run: |
          git config user.name 'GitHub Actions Bot'
          git config user.email 'actions@github.com'
          
          # å¼ºåˆ¶æ·»åŠ  merged-rules æ–‡ä»¶å¤¹
          git add merged-rules/
          
          # ä½¿ç”¨ diff-index æ£€æŸ¥å˜æ›´ï¼Œé¿å…è„šæœ¬æŠ¥é”™
          if git diff-index --quiet HEAD; then
             echo "::notice::No changes detected in rules. Skipping commit."
             echo "changes=false" >> "$GITHUB_OUTPUT"
          else
             # ç»Ÿè®¡æœ‰å¤šå°‘æ–‡ä»¶å˜æ›´
             CHANGE_COUNT=$(git diff --name-only --cached | wc -l)
             echo "::notice::$CHANGE_COUNT files changed. Committing..."
             
             git commit -m "build: ðŸ§© Update $CHANGE_COUNT combined rule files"
             git push
             echo "changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: âœ¨ Final Status
        if: always()
        run: |
          if [ "${{ steps.run_merger.outcome }}" == "success" ]; then
            echo "Job completed successfully."
          else
            echo "::error::Job failed. Check the logs above."
          fi
