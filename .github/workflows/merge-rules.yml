name: "2. Merge Rules based on Config"

on:
  # 1. æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

permissions:
  contents: write

jobs:
  merge:
    runs-on: ubuntu-latest
    name: "ðŸ§© Merge & Validate"
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install Dependencies
        run: |
          pip install pyyaml rich
          echo "### ðŸ“¦ Environment Prepared" >> $GITHUB_STEP_SUMMARY
          echo "- Pthon 3.11 Setup Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Dependencies: PyYAML, Rich installed" >> $GITHUB_STEP_SUMMARY

      # è¿›è¡Œè°ƒè¯• 
      - name: ðŸ” Check File Structure (Debug)
        run: |
          echo "=== Listing rulesets directory ==="
          ls -R rulesets/
          echo "=================================="

      - name: ðŸš€ Run Merger (Strict Mode)
        id: merger
        env:
          TERM: xterm-color
          FORCE_COLOR: "1"
        run: |
          # è¿è¡Œè„šæœ¬ï¼Œå¦‚æžœè„šæœ¬ exit 1ï¼Œæ•´ä¸ª Job ä¼šç«‹å³åœæ­¢
          python3 scripts/merger.py

      - name: ðŸ’¾ Commit & Push
        if: success() # åªæœ‰ä¸Šä¸€æ­¥æˆåŠŸæ‰æ‰§è¡Œ
        run: |
          git config user.name 'GitHub Actions Bot'
          git config user.email 'actions@github.com'
          
          # å¼ºåˆ¶æ·»åŠ  merged-rules ç›®å½•
          git add merged-rules/
          
          echo "### ðŸ’¾ Git Operations" >> $GITHUB_STEP_SUMMARY
          
          if git diff-index --quiet HEAD; then
             echo "::notice::No changes detected."
             echo "- âœ… **Status**: No changes to commit." >> $GITHUB_STEP_SUMMARY
          else
             CHANGE_COUNT=$(git diff --name-only --cached | wc -l)
             COMMIT_MSG="build: ðŸ§© Re-merged $CHANGE_COUNT lists (Strict Structure)"
             
             git commit -m "$COMMIT_MSG"
             git push
             
             echo "- ðŸš€ **Pushed**: $CHANGE_COUNT files changed." >> $GITHUB_STEP_SUMMARY
             echo "- ðŸ“ **Commit**: $COMMIT_MSG" >> $GITHUB_STEP_SUMMARY
          fi
