name: "2. Merge Rules based on Config"

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  merge:
    runs-on: ubuntu-latest
    name: "ğŸ§© Merge & Validate"
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # è¿™ä¸€æ­¥å¿…ä¸å¯å°‘
      - name: ğŸ“¦ Install Dependencies
        run: |
          pip install pyyaml

      - name: ğŸš€ Run Merger
        id: merger
        env:
          TERM: xterm-color
        run: |
          # è¿è¡Œåˆšæ‰çš„è„šæœ¬
          python3 scripts/merger.py

      - name: ğŸ’¾ Commit & Push
        if: success()
        run: |
          git config user.name 'GitHub Actions Bot'
          git config user.email 'actions@github.com'
          
          git add merged-rules/
          
          if git diff-index --quiet HEAD; then
             echo "::notice::No changes in rules."
          else
             CHANGE_COUNT=$(git diff --name-only --cached | wc -l)
             git commit -m "build: ğŸ§© Re-merge $CHANGE_COUNT files from config"
             git push
          fi
