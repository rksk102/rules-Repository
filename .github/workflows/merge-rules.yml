name: "2. Merge Rules based on Config"

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  merge:
    runs-on: ubuntu-latest
    name: "ğŸ§© Merge & Validate"
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ Install Dependencies
        run: |
          pip install pyyaml rich

      - name: ğŸš€ Run Merger
        id: merger
        env:
          TERM: xterm-color
          FORCE_COLOR: "1"  # å¼ºåˆ¶ Rich è¾“å‡ºé¢œè‰²
        run: |
          python3 scripts/merger.py

      - name: ğŸ’¾ Commit & Push
        if: success()
        run: |
          git config user.name 'GitHub Actions Bot'
          git config user.email 'actions@github.com'
          
          # æ·»åŠ æ‰€æœ‰å˜æ›´
          git add merged-rules/
          
          if git diff-index --quiet HEAD; then
             echo "::notice::No changes in rules."
          else
             CHANGE_COUNT=$(git diff --name-only --cached | wc -l)
             git commit -m "build: ğŸ§© Optimized $CHANGE_COUNT rule files"
             git push
          fi
