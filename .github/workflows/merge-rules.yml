name: "2. Merge Rules based on Config"

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["1. Daily Sync and Sanitize Rules"]
    types:
      - completed

permissions:
  contents: write

jobs:
  merge:
    # 仅当上一个流程成功时才运行
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: main 

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Dependencies
        run: pip install PyYAML

      - name: Run Merge Script
        run: |
          chmod +x scripts/merge-rules.sh
          ./scripts/merge-rules.sh

      - name: Commit and Push
        run: |
          git config user.name 'GitHub Actions Bot'
          git config user.email 'actions@github.com'
          
          # 【重点修改】添加 merged-rules 文件夹
          git add merged-rules/
          
          # 检查是否有变更
          if git diff-index --quiet HEAD; then
            echo "No changes in merged rules."
            exit 0
          fi
          
          echo "Changes detected. Committing..."
          git commit -m "build: Update merged rulesets in 'merged-rules/'"
          git push
