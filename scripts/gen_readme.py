#!/usr/bin/env python3
import os
import sys
import time
import urllib.parse

# =================================================
# 1. é…ç½®åŒºåŸŸ
# =================================================
REPO_ROOT = os.getcwd()
MERGED_DIR = os.path.join(REPO_ROOT, "merged-rules")
README_FILE = os.path.join(REPO_ROOT, "README.md")

# åŠ¨æ€è·å–ä»“åº“ä¿¡æ¯ (ä¾‹å¦‚: yourname/your-repo)
REPO_NAME = os.getenv("GITHUB_REPOSITORY", "Outcome/Rule-Set")
BRANCH_NAME = os.getenv("GITHUB_REF_NAME", "main")
OWNER_NAME = REPO_NAME.split("/")[0]

# åŸºç¡€é“¾æ¥æ„å»º
BASE_RAW = f"https://raw.githubusercontent.com/{REPO_NAME}/{BRANCH_NAME}"
BASE_MIRROR = f"https://raw.gitmirror.com/{REPO_NAME}/{BRANCH_NAME}"
BASE_GHPROXY = f"https://ghproxy.net/{BASE_RAW}"

# æ ·å¼é…ç½®
SHIELDS_STYLE = "flat-square"

# =================================================
# 2. è¾…åŠ©å‡½æ•°
# =================================================

def format_size(size_bytes):
    """å°†å­—èŠ‚è½¬æ¢ä¸ºäººç±»å¯è¯»æ ¼å¼ (KB, MB)"""
    if size_bytes == 0: return "0 B"
    units = ("B", "KB", "MB", "GB")
    i = 0
    p = size_bytes
    while p >= 1024 and i < len(units) - 1:
        p /= 1024
        i += 1
    return f"{p:.2f} {units[i]}"

def get_current_time_str():
    """ç”Ÿæˆ URL ç¼–ç çš„æ—¶é—´å­—ç¬¦ä¸²"""
    now = time.strftime("%Y-%m-%d %H:%M")
    return urllib.parse.quote(now)

def scan_rules():
    """æ‰«æåˆå¹¶ç›®å½•"""
    rule_files = []
    if not os.path.exists(MERGED_DIR):
        return []
    for root, _, files in os.walk(MERGED_DIR):
        for file in files:
            # åªè¦æ˜¯æ–‡ä»¶å°±åˆ—å‡ºæ¥ï¼Œä¸é™åˆ¶åç¼€
            if not file.startswith("."):
                full_path = os.path.join(root, file)
                rule_files.append(full_path)
    return sorted(rule_files)

# =================================================
# 3. æ¨¡æ¿ (æ ·å¼å‚è€ƒç‰ˆ - å†…å®¹å·²é€šç”¨åŒ–)
# =================================================

HEADER_TEMPLATE = f"""<div align="center">

<!-- æ ‡é¢˜ -->
<h1>{REPO_NAME.split('/')[-1]}</h1>

<!-- Badges å¾½ç« åŒºåŸŸ -->
[![Build Status](https://img.shields.io/github/actions/workflow/status/{REPO_NAME}/sync-rules.yml?style={SHIELDS_STYLE}&logo=github&label=Build)](https://github.com/{REPO_NAME}/actions)
[![Repo Size](https://img.shields.io/github/repo-size/{REPO_NAME}?style={SHIELDS_STYLE}&label=Size&color=orange)](https://github.com/{REPO_NAME})
[![Updated](https://img.shields.io/badge/Updated-{get_current_time_str()}-blue?style={SHIELDS_STYLE}&logo=time)](https://github.com/{REPO_NAME}/commits/{BRANCH_NAME})

<p>
ğŸš€ <strong>Auto Updates</strong> Â· ğŸŒ <strong>Global CDN</strong> Â· ğŸ¯ <strong>Categorized</strong>
</p>
</div>

<!-- ä¸‰åˆ—ç‰¹æ€§è¡¨æ ¼ -->
<table>
<thead>
<tr>
<th align="center">ğŸ¤– <strong>Automated</strong></th>
<th align="center">âš¡ <strong>Fast</strong></th>
<th align="center">ğŸ“¦ <strong>Organized</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">Daily upstream sync<br>Auto-merge & clean</td>
<td align="center">Multi-CDN support<br>GhProxy / GitMirror</td>
<td align="center">Structured folders<br>Generic compatibility</td>
</tr>
</tbody>
</table>

---

## âš™ï¸ ä½¿ç”¨è¯´æ˜ (Usage)

<div class="markdown-alert markdown-alert-tip">
<p class="markdown-alert-title">Tip</p>
<p>æ¨èä½¿ç”¨ <strong>GhProxy</strong> é€šé“ä»¥ä¸‹è½½è§„åˆ™ï¼Œå¯è·å¾—æ›´å¿«çš„å›½å†…è®¿é—®é€Ÿåº¦ã€‚</p>
</div>

<details>
<summary><strong>ğŸ“ ç‚¹å‡»æŸ¥çœ‹å¼•ç”¨é“¾æ¥ç¤ºä¾‹</strong></summary>

ä½¿ç”¨ä»¥ä¸‹é“¾æ¥æ ¼å¼å¼•ç”¨è§„åˆ™ï¼š

- **GhProxy (æ¨è)**: `https://ghproxy.net/{BASE_RAW}/merged-rules/Category/Name.txt`
- **GitMirror**: `https://raw.gitmirror.com/{REPO_NAME}/{BRANCH_NAME}/merged-rules/Category/Name.txt`
- **GitHub Raw**: `{BASE_RAW}/merged-rules/Category/Name.txt`

</details>

## ğŸ“¥ è§„åˆ™åˆ—è¡¨ (Downloads)

<div class="markdown-alert markdown-alert-note">
<p class="markdown-alert-title">Note</p>
<p>ç‚¹å‡» <code>ğŸš€ Fast Download</code> æŒ‰é’®å¯ç›´æ¥è·å–åŠ é€Ÿé“¾æ¥ã€‚</p>
</div>

| è§„åˆ™åç§° (Name) | ç±»å‹ (Ext) | å¤§å° (Size) | ä¸‹è½½é€šé“ (Download) |
| :--- | :--- | :--- | :--- |
"""

FOOTER_TEMPLATE = """
<div align="center">
<br>
<p><strong>Total Files:</strong> <code>{count}</code></p>
<p><a href="#">ğŸ”¼ Back to Top</a></p>
<sub>Generated by GitHub Actions</sub>
</div>
"""

# =================================================
# 4. æ‰§è¡Œç”Ÿæˆ
# =================================================

def main():
    print("::group::ğŸ“ Generating README...")
    
    files = scan_rules()
    print(f"::notice::Found {len(files)} files to list.")

    try:
        with open(README_FILE, 'w', encoding='utf-8') as f:
            f.write(HEADER_TEMPLATE)
            
            if not files:
                f.write("| âŒ Emtpy | - | - | - |\n")
            else:
                for filepath in files:
                    filename = os.path.basename(filepath)
                    filesize = os.path.getsize(filepath)
                    human_size = format_size(filesize)
                    extension = os.path.splitext(filename)[1].replace(".", "").upper() or "FILE"
                    
                    # è·¯å¾„å¤„ç†
                    display_path = os.path.relpath(filepath, MERGED_DIR) # e.g. reject/domain/geo.txt
                    subdir = os.path.dirname(display_path)               # e.g. reject/domain
                    
                    # æ˜¾ç¤ºè·¯å¾„ (æ ·å¼ä¼˜åŒ–: ğŸ“‚ reject/domain /)
                    dir_tag = f"ğŸ“‚ {subdir} /" if subdir else "ğŸ“‚ Root /"

                    # URL ç”Ÿæˆ (å¼ºåˆ¶ /)
                    url_path = display_path.replace(os.sep, '/')
                    link_ghproxy = f"{BASE_GHPROXY}/merged-rules/{url_path}"
                    link_mirror = f"{BASE_MIRROR}/merged-rules/{url_path}"
                    link_raw = f"{BASE_RAW}/merged-rules/{url_path}"
                    
                    # å†™å…¥è¡Œ
                    row = (
                        f"| <sub>{dir_tag}</sub><br>**{filename}** | "
                        f"`{extension}` | "
                        f"`{human_size}` | "
                        f'<a href="{link_ghproxy}"><img src="https://img.shields.io/badge/ğŸš€_Fast_Download-GhProxy-009688?style={SHIELDS_STYLE}&logo=rocket" alt="Fast Download"></a><br>'
                        f"[CDN Mirror]({link_mirror}) â€¢ [Raw Source]({link_raw}) |\n"
                    )
                    f.write(row)

            f.write(FOOTER_TEMPLATE.format(count=len(files)))
            
        print("::endgroup::")
        print("âœ… README.md updated.")
        
    except Exception as e:
        print(f"::error::Error generating README: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()
