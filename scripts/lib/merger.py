#!/usr/bin/env python3
import os
import yaml
import glob
import sys
import shutil

# =========================
# 配置区域
# =========================
CONFIG_FILE = "merge-config.yaml"
SOURCE_DIR = "rulesets"
DIST_DIR = "merged-rules"  # <--- 已修改为 'merged-rules'

def load_config(path):
    if not os.path.exists(path):
        print(f"Error: Config file '{path}' not found.")
        sys.exit(1)
    with open(path, 'r', encoding='utf-8') as f:
        try:
            return yaml.safe_load(f)
        except yaml.YAMLError as exc:
            print(f"Error parsing YAML: {exc}")
            sys.exit(1)

def get_file_content(filepath):
    lines = set()
    try:
        with open(filepath, 'r', encoding='utf-8') as f:
            for line in f:
                line = line.strip()
                if not line or line.startswith('#') or line.startswith('//'):
                    continue
                lines.add(line)
    except Exception as e:
        print(f"  [Warn] Cannot read {filepath}: {e}")
    return lines

def write_txt(filepath, rules, description=""):
    # 确保目录存在
    os.makedirs(os.path.dirname(filepath), exist_ok=True)
    
    with open(filepath, 'w', encoding='utf-8') as f:
        if description:
             f.write(f"# {description}\n")
        f.write(f"# Total Rules: {len(rules)}\n")
        f.write(f"# Generated by Rule-Merge-System\n")
        
        for rule in sorted(list(rules)):
            f.write(f"{rule}\n")
            
    print(f"  -> Generated Merged File: {filepath} ({len(rules)} lines)")

def mirror_raw_files():
    """
    镜像复制：将 rulesets 所有文件原封不动复制到 merged-rules 目录，保持结构。
    """
    print(f">>> Mirroring raw files from {SOURCE_DIR} to {DIST_DIR}...")
    files_count = 0
    for root, dirs, files in os.walk(SOURCE_DIR):
        for file in files:
            if not file.endswith(('.txt', '.list', '.yaml', '.conf')):
                continue
            
            src_path = os.path.join(root, file)
            # 计算相对路径，例如 block/domain/xxx.txt
            rel_path = os.path.relpath(src_path, SOURCE_DIR)
            # 目标路径: merged-rules/block/domain/xxx.txt
            dest_path = os.path.join(DIST_DIR, rel_path)
            
            os.makedirs(os.path.dirname(dest_path), exist_ok=True)
            shutil.copy2(src_path, dest_path)
            files_count += 1
    print(f"  -> Mirrored {files_count} raw files.")

def process_merges(config):
    """处理配置合并逻辑"""
    if not config or 'merges' not in config:
        print("No 'merges' keys found in config.")
        return

    tasks = config['merges']
    print(f"\n>>> Processing {len(tasks)} merge tasks...")

    for task in tasks:
        name = task.get('name')
        inputs = task.get('inputs', [])
        desc = task.get('description', "")
        
        if not name or not inputs: continue
            
        processed_name = f"Merged-{name}" # 为了显眼，可以选择加个前缀，或者保持原名
        # 这里我们直接用配置里的名字放在 merge-rules 根目录下
        
        merged_rules = set()
        for input_pattern in inputs:
            full_pattern = os.path.join(SOURCE_DIR, input_pattern)
            found_files = glob.glob(full_pattern, recursive=True)
            for filepath in found_files:
                if os.path.isfile(filepath):
                    merged_rules.update(get_file_content(filepath))
        
        # 输出到 merged-rules/文件名
        output_path = os.path.join(DIST_DIR, name)
        write_txt(output_path, merged_rules, desc)

def main():
    # 每次运行前清理目标目录 (确保没有残留)
    # if os.path.exists(DIST_DIR):
    #     shutil.rmtree(DIST_DIR)
    os.makedirs(DIST_DIR, exist_ok=True)

    print(f">>> Loading config from {CONFIG_FILE}...")
    config = load_config(CONFIG_FILE)

    # 1. 镜像原始文件 (保持格式)
    mirror_raw_files()
    
    # 2. 生成合并文件
    process_merges(config)

    print("\n>>> All operations complete.")

if __name__ == "__main__":
    main()
